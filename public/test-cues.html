<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Dynamic Cue System</title>
    <style>
        body {
            font-family: monospace;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: #1a1a1a;
            color: #00ff00;
        }
        h1 { color: #00ffff; }
        .test-section {
            background: #2a2a2a;
            padding: 15px;
            margin: 15px 0;
            border: 1px solid #00ff00;
            border-radius: 5px;
        }
        .success { color: #00ff00; }
        .error { color: #ff0000; }
        .warning { color: #ffaa00; }
        pre {
            background: #000;
            padding: 10px;
            border-radius: 3px;
            overflow-x: auto;
        }
        button {
            background: #00ff00;
            color: #000;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            font-weight: bold;
            border-radius: 3px;
        }
        button:hover {
            background: #00ffff;
        }
    </style>
</head>
<body>
    <h1>üî¨ DYNAMIC CUE SYSTEM - DIAGNOSTIC TEST</h1>
    
    <div class="test-section">
        <h2>üìä Test Status</h2>
        <div id="status">Ready to test...</div>
    </div>

    <div class="test-section">
        <h2>üéØ Quick Tests</h2>
        <button onclick="testEmptyRawCues()">Test Empty Raw Cues</button>
        <button onclick="testRepeatedCues()">Test Repeated Cues</button>
        <button onclick="testFullConversation()">Test Full Conversation (10 turns)</button>
        <button onclick="clearResults()">Clear Results</button>
    </div>

    <div class="test-section">
        <h2>üìã Test Results</h2>
        <div id="results"></div>
    </div>

    <script>
        // Mock the HCP_CUES object
        const HCP_CUES = {
            TIME_PRESSURE: { id: 'time-pressure', name: 'Time Pressure', category: 'stress', severity: 'medium' },
            LOW_ENGAGEMENT: { id: 'low-engagement', name: 'Low Engagement', category: 'engagement', severity: 'medium' },
            FRUSTRATION: { id: 'frustration', name: 'Frustration', category: 'stress', severity: 'high' },
            DEFENSIVE: { id: 'defensive', name: 'Defensive', category: 'resistance', severity: 'medium' },
            DISTRACTED: { id: 'distracted', name: 'Distracted', category: 'engagement', severity: 'low' },
            HESITANT: { id: 'hesitant', name: 'Hesitant', category: 'resistance', severity: 'low' },
            UNCOMFORTABLE: { id: 'uncomfortable', name: 'Uncomfortable', category: 'stress', severity: 'medium' },
            IMPATIENT: { id: 'impatient', name: 'Impatient', category: 'stress', severity: 'high' },
            DISINTERESTED: { id: 'disinterested', name: 'Disinterested', category: 'engagement', severity: 'high' },
            WITHDRAWN: { id: 'withdrawn', name: 'Withdrawn', category: 'resistance', severity: 'high' }
        };

        // Mock conversation context
        let conversationContext = {
            turnNumber: 0,
            previousCues: [],
            hcpMood: 'stable'
        };

        function log(message, type = 'info') {
            const resultsDiv = document.getElementById('results');
            const className = type === 'error' ? 'error' : type === 'warning' ? 'warning' : 'success';
            resultsDiv.innerHTML += `<div class="${className}">${message}</div>`;
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
            conversationContext = {
                turnNumber: 0,
                previousCues: [],
                hcpMood: 'stable'
            };
            document.getElementById('status').innerHTML = 'Ready to test...';
        }

        function selectRandomCues(cues, count) {
            const shuffled = [...cues].sort(() => Math.random() - 0.5);
            return shuffled.slice(0, count);
        }

        function generateContextualCues(turnNumber, mood, availableCues) {
            console.log('[TEST] generateContextualCues called:', {
                turnNumber,
                mood,
                availableCount: availableCues.length,
                availableIds: availableCues.map(c => c.id)
            });

            if (availableCues.length === 0) {
                console.log('[TEST] No available cues! Using all cues as fallback');
                const allCues = Object.values(HCP_CUES);
                const selected = selectRandomCues(allCues, 2);
                console.log('[TEST] Emergency fallback selected:', selected.map(c => c.id));
                return selected;
            }

            const selected = selectRandomCues(availableCues, 2);
            console.log('[TEST] Selected cues:', selected.map(c => c.id));
            return selected;
        }

        function selectDynamicCues(rawDetectedCues, context) {
            const recentCues = context.previousCues.slice(-6);
            const availableCues = Object.values(HCP_CUES).filter(
                cue => !recentCues.includes(cue.id)
            );

            if (rawDetectedCues.length === 0) {
                return generateContextualCues(context.turnNumber, context.hcpMood, availableCues);
            }

            const filteredCues = rawDetectedCues.filter(
                cue => !recentCues.includes(cue.id)
            );

            if (filteredCues.length === 0) {
                return generateContextualCues(context.turnNumber, context.hcpMood, availableCues);
            }

            return filteredCues.slice(0, 2);
        }

        function testEmptyRawCues() {
            clearResults();
            log('<h3>TEST 1: Empty Raw Cues (Backend has no keywords)</h3>');
            log('Simulating backend response with NO cue keywords...');

            conversationContext.turnNumber = 1;
            const rawCues = []; // Empty - no keywords detected
            const cues = selectDynamicCues(rawCues, conversationContext);

            log(`Turn ${conversationContext.turnNumber}: Raw cues = ${rawCues.length}, Generated cues = ${cues.length}`);
            log(`Cues: ${cues.map(c => c.name).join(', ')}`, cues.length === 2 ? 'success' : 'error');

            if (cues.length !== 2) {
                log('‚ùå FAILED: Should return 2 cues', 'error');
            } else {
                log('‚úÖ PASSED: Returned 2 cues', 'success');
            }

            // Update context
            conversationContext.previousCues.push(...cues.map(c => c.id));
            conversationContext.turnNumber++;
        }

        function testRepeatedCues() {
            clearResults();
            log('<h3>TEST 2: Repeated Cues (Same cues shouldn\'t repeat)</h3>');

            const allCues = [];
            for (let i = 1; i <= 5; i++) {
                conversationContext.turnNumber = i;
                const rawCues = [];
                const cues = selectDynamicCues(rawCues, conversationContext);

                log(`Turn ${i}: ${cues.map(c => c.name).join(', ')}`);
                allCues.push(...cues.map(c => c.id));

                // Update context
                conversationContext.previousCues.push(...cues.map(c => c.id));
            }

            // Check for variety
            const uniqueCues = new Set(allCues);
            log(`<br>Total cues shown: ${allCues.length}`);
            log(`Unique cues: ${uniqueCues.size}`);

            if (uniqueCues.size >= 8) {
                log('‚úÖ PASSED: Good variety (8+ unique cues)', 'success');
            } else if (uniqueCues.size >= 5) {
                log('‚ö†Ô∏è WARNING: Moderate variety (5-7 unique cues)', 'warning');
            } else {
                log('‚ùå FAILED: Poor variety (<5 unique cues)', 'error');
            }
        }

        function testFullConversation() {
            clearResults();
            log('<h3>TEST 3: Full Conversation (10 turns)</h3>');

            const allCues = [];
            const cuesByTurn = [];

            for (let i = 1; i <= 10; i++) {
                conversationContext.turnNumber = i;
                const rawCues = [];
                const cues = selectDynamicCues(rawCues, conversationContext);

                const cueNames = cues.map(c => c.name).join(', ');
                cuesByTurn.push({ turn: i, cues: cueNames });
                allCues.push(...cues.map(c => c.id));

                // Update context
                conversationContext.previousCues.push(...cues.map(c => c.id));
            }

            // Display results
            log('<pre>' + JSON.stringify(cuesByTurn, null, 2) + '</pre>');

            // Analysis
            const uniqueCues = new Set(allCues);
            log(`<br><strong>Analysis:</strong>`);
            log(`Total cues shown: ${allCues.length}`);
            log(`Unique cues: ${uniqueCues.size} / 10 available`);
            log(`Coverage: ${(uniqueCues.size / 10 * 100).toFixed(1)}%`);

            // Check for consecutive repeats
            let hasConsecutiveRepeats = false;
            for (let i = 0; i < allCues.length - 2; i++) {
                if (allCues[i] === allCues[i + 2]) {
                    hasConsecutiveRepeats = true;
                    log(`‚ö†Ô∏è Cue "${allCues[i]}" repeated within 3 turns`, 'warning');
                }
            }

            if (!hasConsecutiveRepeats && uniqueCues.size >= 8) {
                log('‚úÖ PASSED: Excellent variety, no consecutive repeats', 'success');
            } else if (!hasConsecutiveRepeats) {
                log('‚ö†Ô∏è WARNING: No repeats but limited variety', 'warning');
            } else {
                log('‚ùå FAILED: Has consecutive repeats', 'error');
            }
        }

        // Auto-run on load
        window.onload = function() {
            document.getElementById('status').innerHTML = '<span class="success">‚úÖ Test page loaded. Click a test button to begin.</span>';
        };
    </script>
</body>
</html>